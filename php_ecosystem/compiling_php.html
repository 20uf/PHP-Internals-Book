

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Compiling PHP from sources &mdash; PHP Internals Book</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/theme_extras.js"></script>
    <link rel="top" title="PHP Internals Book" href="../index.html" />
    <link rel="up" title="PHP ecosystem : Preparing PHP source code" href="../php_ecosystem.html" />
    <link rel="next" title="Building PHP Extensions" href="extensions_pecl.html" />
    <link rel="prev" title="Packages versus sources" href="packages_vs_source.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../index.html">
          <span>PHP Internals Book</span></a></h1>
        <h2 class="heading"><span>Compiling PHP from sources</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="packages_vs_source.html">Packages versus sources</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="extensions_pecl.html">Building PHP Extensions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="compiling-php-from-sources">
<span id="compiling-php"></span><h1>Compiling PHP from sources<a class="headerlink" href="#compiling-php-from-sources" title="Permalink to this headline">¶</a></h1>
<div class="section" id="recall-on-compilation">
<h2>Recall on compilation<a class="headerlink" href="#recall-on-compilation" title="Permalink to this headline">¶</a></h2>
<p>From what you know or learnt reading our {link}prerequisites chapter{link}, it&#8217;s now the moment to turn PHP&#8217;s source code to machine instructions and build the program so that it will run on your platform.
This chapter focuses on PHP mainly, and we don&#8217;t know anything about your system, except we assume it is supported by PHP. Remind that this book takes as example Linux based platforms, mainly Debian. We assume you master you system.
Should you really know your hardware and your system, you would use any custom compiler, compiler module or extension, as well as any compiler special switch. We&#8217;ll here use default ones, but show you some cool stuff coming from the <em>GCC</em> compilation tool.</p>
</div>
<div class="section" id="getting-sources-and-dependencies-ready">
<h2>Getting sources and dependencies ready<a class="headerlink" href="#getting-sources-and-dependencies-ready" title="Permalink to this headline">¶</a></h2>
<p>There exists two different ways to grab PHP original source code : from packages we provide behind <a class="reference external" href="http://download.php.net">http://download.php.net</a> , this is usually what you&#8217;ll do. The other way is to check out the source code directly from our git repository, located at <a class="reference external" href="http://git.php.net">http://git.php.net</a> (mirrored on Github, at <a class="reference external" href="http://www.github.com/php-src">http://www.github.com/php-src</a>).
Those two ways differ a little bit when comes the time to compile PHP. Here are what we can say about them :</p>
<blockquote>
<div><ul class="simple">
<li>PHP coming from git doesn&#8217;t bundle a default configure script, you will have to generate it, so you&#8217;ll need to run our <tt class="docutils literal"><span class="pre">buildconf</span></tt> script, which itself relies on the autotools suite you&#8217;ll have to install if not done yet.</li>
<li>PHP coming from git doesn&#8217;t bundle generated lexer and parser, you&#8217;ll have to build them, so you&#8217;ll need re2c and bison tools.</li>
</ul>
</div></blockquote>
<p>Basically, a PHP source coming from our packages is just ready to be built but a PHP source coming from a checkout of any branch from git will need more tools to get those sources prepared for compilation.</p>
<div class="section" id="first-look-at-the-configure-script">
<h3>First look at the configure script<a class="headerlink" href="#first-look-at-the-configure-script" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none"><div class="highlight"><pre>&gt; mkdir /tmp/phpsrc &amp;&amp; cd /tmp/phpsrc
/tmp/phpsrc&gt; wget http://us.php.net/get/php-5.4.15.tar.gz/from/this/mirror
/tmp/phpsrc&gt; tar xzf php-5.4.15.tar.gz &amp;&amp; cd php-5.4.15
/tmp/phpsrc/php-5.4.15&gt; ls -al
</pre></div>
</div>
<p>There we downloaded PHP from one of our mirror, unpacked it and browsed the files. We can see a configure script, let&#8217;s now run it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember that if you get PHP from git, the configure script is not present in the tree. You should then run the buildconf.sh script which will invoke the autotools chain, mainly parsing the .m4 templates and generate a configure script for you. Starting from PHP 5.4, we support autoconf 2.59, notice that before PHP5.4, only autoconf 2.13 is supported.</p>
</div>
<div class="highlight-none"><div class="highlight"><pre>/tmp/phpsrc/php-5.4.15&gt; ./configure --help | less
</pre></div>
</div>
<p>Here you can see all the switches we provide to set up PHP. There are many of them, and we assume you are used to running the configure script, so we won&#8217;t (and can&#8217;t) detail all the options you would be able to use.
Remember that dependi  ng on the version of PHP you use, those switches may differ. For example, we bundle different extensions in different PHP versions setups.</p>
<p>Let&#8217;s prepare for a default installation :</p>
<div class="highlight-none"><div class="highlight"><pre>/tmp/phpsrc/php-5.4.15&gt; ./configure --prefix=/home/myuser/myphp
</pre></div>
</div>
<p>Depending on you system, the configure script ends up with an error saying that some libraries are missing. By default, when you want to compile PHP, XML support is enabled, and we need libxml2 to provide such a support. Usually the header files for this lib are not installed and configure cannot continue. It may also be the case for other required libraries. Read the output of configure script, and download all the libraries needed, as well as their header files (usually provided by a <em>&#8220;-dev&#8221;</em> package from you package manager tool).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It even can happen that no compiling suite is found on your system by default. A C compiler is needed to build PHP, as well as a C++ compiler, a C preprocessor and a linker. If you rely on Unix and GNU tools, usually the <em>GCC</em> suite provides all you need about that.
On Debian based systems, the <em>build-essential</em> package provides all tools needed to compile software for you system, it is then a good choice to have it installed.</p>
</div>
<p>Just running configure script out of the box will prepare PHP sources to be compiled by checking that your system provides all dependencies PHP needs. Once done, it should end successfully with something like :</p>
<div class="highlight-none"><div class="highlight"><pre>Generating files
configure: creating ./config.status
creating main/internal_functions.c
creating main/internal_functions_cli.c
+--------------------------------------------------------------------+
| License:                                                           |
| This software is subject to the PHP License, available in this     |
| distribution in the file LICENSE.  By continuing this installation |
| process, you are bound by the terms of this license agreement.     |
| If you do not agree with the terms of this license, you must abort |
| the installation process at this point.                            |
+--------------------------------------------------------------------+

Thank you for using PHP.

config.status: creating php5.spec
config.status: creating main/build-defs.h
config.status: creating scripts/phpize
config.status: creating scripts/man1/phpize.1
config.status: creating scripts/php-config
config.status: creating scripts/man1/php-config.1
config.status: creating sapi/cli/php.1
config.status: creating main/php_config.h
config.status: executing default commands
</pre></div>
</div>
<p>Huray, sources are now ready to be compiled.</p>
</div>
</div>
<div class="section" id="let-s-make-and-install-it">
<h2>Let&#8217;s make and install it !<a class="headerlink" href="#let-s-make-and-install-it" title="Permalink to this headline">¶</a></h2>
<p>Once your sources are ready, you now have to compile them all. As PHP relies on autotools and make to get compiled, all you have to do now is run the <tt class="docutils literal"><span class="pre">make</span></tt> tool, and, that&#8217;s it !</p>
<div class="highlight-none"><div class="highlight"><pre>/tmp/phpsrc/php-5.4.15&gt; make
</pre></div>
</div>
<p>make should end successfully, with something like :</p>
<div class="highlight-none"><div class="highlight"><pre>Build complete.
Don&#39;t forget to run &#39;make test&#39;
</pre></div>
</div>
<p>It encourages you to run the <tt class="docutils literal"><span class="pre">make</span> <span class="pre">test</span></tt> command. This command will run the <em>test</em> target from the <tt class="docutils literal"><span class="pre">MakeFile</span></tt> file, which will run the freshly-built PHP binary against our test suite, located into the different <em>tests/</em> directories of the PHP source tree.
Nowadays, we provide by default about 9000 tests, and unfortunately the tests are not run in parallel yet, thus the <tt class="docutils literal"><span class="pre">make</span> <span class="pre">test</span></tt> command can take up to 5min to complete, depending on your hardware.</p>
<p>If this is the first time you compile PHP on your platform, we encourage you to run the test suite. Depending on your OS, your environment and most of all : your hardware and your compiler, you may find bugs in PHP by running the test suite. The good new is that all is autommated, at the end of the test suite run, the script will ask you if you want to send the report. If you say yes, a report will be uploaded to our qa platform, and it can be analyzed by our automates or our contributors later on. Thank you for this free and easy step :-)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are experiencing problems compiling PHP, we provide a help paragraph at the end of this chapter.</p>
</div>
<p>PHP is compiled, now it is time to install it :</p>
<div class="highlight-none"><div class="highlight"><pre>/tmp/phpsrc/php-5.4.15&gt; make install
</pre></div>
</div>
<p>The compiled files will be installed in the directory you provided to the <tt class="docutils literal"><span class="pre">--prefix</span></tt> switch of the configure script. For a try, it is usually a good idea to store the installed files somewhere behind your home directory. As an example, we used <em>/home/myuser/myphp</em></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You will have noticed that you should customize this directory ( <em>/home/myuser/myphp</em> ) and make it fit your user account or your needs.</p>
</div>
<div class="section" id="check-all-is-right">
<h3>Check all is right<a class="headerlink" href="#check-all-is-right" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s have a look at the default install tree :</p>
<div class="highlight-none"><div class="highlight"><pre>&gt; tree -L 3 /home/myuser/myphp

/home/myuser/myphp
|-- bin
|   |-- pear
|   |-- peardev
|   |-- pecl
|   |-- phar -&gt; /tmp/myphp/bin/phar.phar
|   |-- phar.phar
|   |-- php
|   |-- php-cgi
|   |-- php-config
|   `-- phpize
|-- etc
|   `-- pear.conf
|-- include
|   `-- php
|       |-- ext
|       |-- include
|       |-- main
|       |-- sapi
|       |-- TSRM
|       `-- Zend
|-- lib
|   `-- php
|       |-- Archive
|       |-- build
|       |-- Console
|       |-- data
|       |-- doc
|       |-- OS
|       |-- PEAR
|       |-- PEAR5.php
|       |-- pearcmd.php
|       |-- PEAR.php
|       |-- peclcmd.php
|       |-- Structures
|       |-- System.php
|       |-- test
|       `-- XML
`-- php
    `-- man
        `-- man1
</pre></div>
</div>
<p>Quick tour :</p>
<blockquote>
<div><ul class="simple">
<li><em>bin/</em> contains obviously binaries. The most important is the CLI PHP : <em>bin/php</em></li>
<li><em>etc/</em> contains obviously configuration. Note that the default php.ini directory is <em>not</em> here</li>
<li><em>include/php</em> contains header files which will be needed if you want to further build extensions or embed any part of PHP to a custom software</li>
<li><em>lib/php</em> contains PEAR default files. It is also the default php.ini directory and the default extensions directory</li>
<li><em>php/man</em> obviously contains man pages for the <tt class="docutils literal"><span class="pre">php</span></tt> command.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you don&#8217;t provide a <tt class="docutils literal"><span class="pre">--prefix</span></tt> switch to your <em>configure</em> command, default location is <tt class="docutils literal"><span class="pre">/usr/local</span></tt>. PHP&#8217;ll then be merged to the <tt class="docutils literal"><span class="pre">/usr/local</span></tt> tree, which is all right and respects the {link}Linux Standard Directory Structure{link}
If you want to build several versions of PHP, the easiest way is to customize the place they&#8217;ll be installed in, by playing with the <em>&#8211;prefix</em> configure switch. Each installation directory is totally independant from each other.</p>
</div>
<p>Now let&#8217;s check our binary against several switches to see what to expect from it :</p>
<div class="highlight-none"><div class="highlight"><pre>~/myphp&gt; cd bin
~/myphp/bin&gt; ./php -v
PHP 5.4.15 (cli) (built: Jun 13 2013 12:24:03)
Copyright (c) 1997-2013 The PHP Group
Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies
</pre></div>
</div>
<p>Ok, this is our PHP.</p>
<div class="highlight-none"><div class="highlight"><pre>~/myphp/bin&gt; ./php -m
[PHP Modules]
Core
ctype
date
dom
ereg
fileinfo
filter
hash
iconv
json
libxml
pcre
PDO
pdo_sqlite
Phar
posix
Reflection
session
SimpleXML
SPL
sqlite3
standard
tokenizer
xml
xmlreader
xmlwriter

[Zend Modules]
</pre></div>
</div>
<p>Here you can see a list of the default extensions which are activated if you don&#8217;t touch anything about the configure script.
Default activated extensions may vary upon the PHP version you compile.</p>
<div class="highlight-none"><div class="highlight"><pre>~/myphp/bin&gt; ./php --ini
Configuration File (php.ini) Path: /tmp/myphp/lib
Loaded Configuration File:         (none)
Scan for additional .ini files in: (none)
Additional .ini files parsed:      (none)
</pre></div>
</div>
<p>Interesting here. Against what you could expect, PHP wont look for a <em>php.ini</em> configuration file in its own <em>etc/</em> directory, but in its <em>lib/</em> directory. And you also can notice that, by default, no <em>php.ini</em> is provided.
There exists two <em>php.ini</em> into the source directory, it is your responsability to use them if you want, so you have to copy them on your own. You could also use a custom <em>php.ini</em> you write from scratch.</p>
<div class="highlight-none"><div class="highlight"><pre>~/myphp/bin&gt; cp /tmp/phpsrc/php-5.4.15/php.ini-development ~/myphp/lib/php.ini
~/myphp/bin&gt; ./php --ini
Configuration File (php.ini) Path: /tmp/myphp/lib
Loaded Configuration File:         /tmp/myphp/lib/php.ini
Scan for additional .ini files in: (none)
Additional .ini files parsed:      (none)
</pre></div>
</div>
<p>Here we just copied a default <em>php.ini</em> in the default directory and confirmed that PHP now really uses it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can customize the <em>php.ini</em> path, as well as <em>&#8220;additional .ini files&#8221;</em>. We show you all that in a paragraph later in this chapter.
We&#8217;d like to remind you as well that PHP not necessarily looks for a <em>&#8220;php.ini&#8221;</em> file, it also looks for a <em>&#8220;php-{sapi name}.ini&#8221;</em> file. The name of the ini file can be customized depending on the SAPI, so, for a CLI PHP, you could use a <em>php-cli.ini</em>, and for the CGI PHP, a <em>php-cgi.ini</em>. This is interesting as PHP generally should behaves differently depending on the SAPI it is run from. Linux distribution packages usually rely on such a feature to build flexible trees of PHP installations.</p>
</div>
<div class="highlight-none"><div class="highlight"><pre>~/myphp/bin&gt; ldd ./php
linux-vdso.so.1 =&gt;  (0x00007fff0adff000)
    libcrypt.so.1 =&gt; /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007f9689077000)
    libresolv.so.2 =&gt; /lib/x86_64-linux-gnu/libresolv.so.2 (0x00007f9688e61000)
    librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f9688c58000)
    libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f96889d6000)
    libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f96887d2000)
    libnsl.so.1 =&gt; /lib/x86_64-linux-gnu/libnsl.so.1 (0x00007f96885b9000)
    libxml2.so.2 =&gt; /usr/lib/x86_64-linux-gnu/libxml2.so.2 (0x00007f9688457000)
    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f96880cd000)
    libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f9687eb0000)
    /lib64/ld-linux-x86-64.so.2 (0x00007f96892d2000)
    libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f9687c99000)
    liblzma.so.5 =&gt; /lib/x86_64-linux-gnu/liblzma.so.5 (0x00007f9687a76000)
</pre></div>
</div>
<p>Here we checked the dependencies of this PHP build against the system libraries. By default, with a default <tt class="docutils literal"><span class="pre">./configure</span></tt> command, some extensions get compiled, and those, as well as PHP Core, need dynamic shared libraries to work.
If you dont know what shared libraries are and what they provide, please, check our chapter about {link}prerequisites{link}</p>
</div>
</div>
<div class="section" id="php-tools-provided-with-installation">
<h2>PHP tools provided with installation<a class="headerlink" href="#php-tools-provided-with-installation" title="Permalink to this headline">¶</a></h2>
<p>Until now, we talked about the PHP binary. But the bin/ directory created by the setup not only contains the PHP binary. It contains also usefull binaries or scripts, which will be needed for later extension compilation.
Extensions are treated in their own chapter, here, we&#8217;ll present tools that help building them.</p>
<div class="section" id="phpize">
<h3>phpize<a class="headerlink" href="#phpize" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">make</span> <span class="pre">install</span></tt> creates by default a <em>bin/phpize</em> file. This is a shell script which is responsible for importing the PHP files to an extension directory in order to further prepare it, compile it and install it.
We will talk again about this file in the extension dedicated chapter. What important thing you should know is that this file is really tied to this <em>particular PHP setup</em>, and will be needed if you further want to build extensions for <em>this particular PHP setup</em>.</p>
<p>To have an idea, <em>phpize</em> is a shell script, so, go and watch its source. It&#8217;s trivial to read and understand.</p>
</div>
<div class="section" id="php-config">
<h3>php-config<a class="headerlink" href="#php-config" title="Permalink to this headline">¶</a></h3>
<p>In the installed <em>bin/</em> directory, you can also find another important file called php-config. This is an executable shell script you can run.
Let&#8217;s go for it :</p>
<div class="highlight-none"><div class="highlight"><pre>~/myphp/bin&gt; php-config
Usage: ~/myphp/bin/php-config [OPTION]
Options:
  --prefix            [/home/myuser/myphp/bin/myphp]
  --includes          [-I/home/myuser/myphp/include/php -I/home/myuser/myphp/include/php/main -I/home/myuser/myphp/include/php/TSRM -I/home/myuser/myphp/include/php/Zend -I/home/myuser/myphp/include/php/ext -I/home/myuser/myphp/include/php/ext/date/lib]
  --ldflags           []
  --libs              [-lcrypt   -lresolv -lcrypt -lrt -lrt -lm -ldl -lnsl  -lxml2 -lxml2 -lxml2 -lcrypt -lxml2 -lxml2 -lxml2 -lcrypt ]
  --extension-dir     [/home/myuser/myphp/lib/php/extensions/debug-non-zts-20100525]
  --include-dir       [/home/myuser/myphp/include/php]
  --man-dir           [/home/myuser/myphp/php/man]
  --php-binary        [/home/myuser/myphp/bin/php]
  --php-sapis         [ cli cgi]
  --configure-options [--prefix=/home/myuser/myphp --enable-debug]
  --version           [5.4.16-dev]
  --vernum            [50416]
</pre></div>
</div>
<p>This script is a <em>pkg-config</em> like script. It is aimed to be invoked by the compiler when compiling future extensions for this PHP build. You usually provide its path to the configure script of any extension.
Appart from that, this script has two important options you could need further in your development : it recalls you about the default extension directory of this PHP build, as well as the configure options which were used to build this particular PHP.
Those informations can also be extracted from <tt class="docutils literal"><span class="pre">phpinfo()</span></tt> call, though this is little bit cumbersome as the outpout of <tt class="docutils literal"><span class="pre">phpinfo()</span></tt> will have to be parsed. <em>php-config</em> directly gives usefull informations about the PHP setup.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are not used to the <em>pkg-config</em> tool, it could be interesting you grab more informations about it using your favorite search engine. That way you will fully understand the usage of <em>php-config</em>.</p>
</div>
</div>
</div>
<div class="section" id="customizing-php-compilation">
<h2>Customizing PHP compilation<a class="headerlink" href="#customizing-php-compilation" title="Permalink to this headline">¶</a></h2>
<p>We know how to compile PHP. We&#8217;ll now concentrate on particular <em>./configure</em> switches aimed to customize many things in the PHP setup. Just invoking the configure script without any option leads to a default PHP install.
Let&#8217;s now customize it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s both impossible and useless to detail all the <em>configure</em> script options. Most of them are taken from default <em>autoconf</em> configuration. We encourage you to learn more about <em>autoconf</em> and <em>autotools</em> if you are not familiar with them. This will help you understand lots of <em>configure</em> options.</p>
</div>
<div class="section" id="interesting-configure-switches">
<h3>Interesting configure switches<a class="headerlink" href="#interesting-configure-switches" title="Permalink to this headline">¶</a></h3>
<p>If you just need to test very basic feature of PHP, you could provide the <em>&#8211;disable-all</em> switch, which disable all non-needed extensions.
Turning on this switch activates all the &#8211;disable possible switches, thus ending, if no more &#8211;enable switches were used, in a very tiny PHP binary, having a low memory footprint, but also having far less embeded features.
Running some stuff against a tiny PHP, just to show :</p>
<div class="highlight-none"><div class="highlight"><pre>&gt; /path/to/tinyphp/bin/php -m
Core
date
ereg
pcre
Reflection
SPL
standard
</pre></div>
</div>
<p>Those extensions are the minimum required ones, we talk about them deeper in the dedicated chapter about extensions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">A &#8220;tiny&#8221; PHP, compiled with just <em>&#8211;disable-all</em> switch, is often useless : no XML support at all, not even sessions. This is just a version you could use if you dont want the compilation to last too much (as it is very little, very few files get compiled, thus a minimal compilation time) or if you just need very basic PHP features (strings, array, functions and that&#8217;s nearly all) with little memory footprint.</p>
</div>
<p>You have lots of switches to activate extensions mainly. We won&#8217;t talk about all of them, but <em>&#8211;with-libedit</em> or <em>&#8211;with-libreadline</em> let you build a PHP with a nice interactive mode looking like a REPL (Read Eval Print Loop). You launch it using <em>-a</em> switch on the PHP binary, like this:</p>
<div class="highlight-none"><div class="highlight"><pre>&gt;/path/to/php/bin/php -a
Interactive shell

php &gt; $a = &quot;foo&quot;;
php &gt; var_dump($a);
string(3) &quot;foo&quot;
php &gt; $b = 3; $c = 8;
php &gt; echo $b+$c;
11
php &gt;
</pre></div>
</div>
<p>Finally we have to talk about this crucial switch you use whenever you develop in PHP source code or you write an extension : the <em>&#8211;enable-debug</em> switch. It tells the building suite to make a debug version of PHP. If you read the source, it&#8217;s all about <tt class="docutils literal"><span class="pre">#ifdef</span> <span class="pre">ZEND_DEBUG</span></tt> macros.
You recognize a PHP with debug switch in several ways :</p>
<blockquote>
<div><ul class="simple">
<li>Just ask for php -v output, it will clearly show &#8220;DEBUG&#8221;</li>
<li>Invoke <em>php-config &#8211;configure-options</em> and grep &#8220;debug&#8221;</li>
</ul>
</div></blockquote>
<p>What should be known about debug mode is that the extensions must be built with debug mode as well to work. It even happens that the default extensions directory name is built with the debug flag into it :</p>
<blockquote>
<div><ul class="simple">
<li>For a PHP compiled with debug flag : <em>lib/php/extensions/debug-non-zts-20100525</em></li>
<li>For a PHP compiled without debug flag : <em>lib/php/extensions/no-debug-non-zts-20100525</em></li>
</ul>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">You cannot not run extensions compiled for a no-debug PHP on a PHP compiled with debug flag, and vice-versa. Even if this is the exact same version of PHP : you have to recompile the extensions in debug mode.</p>
</div>
<p>Also, never run a debug build of PHP in production mode.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Never run a debug build of PHP in production.</p>
</div>
<p>Seriously, the debug flag slows down PHP execution in so many ways. That&#8217;s normal, debug adds many more checks everywhere in the C code, structures are usually heavier thus leading to a bigger memory footprint as well.
Also, enabling debug automatically turns off every compiler optimisation passes, which for GCC means invoking it with the <em>-O0</em> flag.</p>
</div>
<div class="section" id="make-options">
<h3>make options<a class="headerlink" href="#make-options" title="Permalink to this headline">¶</a></h3>
<p>If you know make, then it&#8217;s OK. If not, we recommand you to use the <em>-j</em> flag which basically tells make to run compilation in parallel, distributing compilation tasks on several CPUs / Cores. Use it with the number of Cores you have on your machine.</p>
<div class="highlight-none"><div class="highlight"><pre>&gt; grep &quot;cpu cores&quot; /proc/cpuinfo
cpu cores     4
path/to/phpsrc &gt; make -j4
</pre></div>
</div>
<p>If you happen to compile PHP with lots of extensions activated, the time taken to compile can grow up to several minutes on modern hardware, thus the <em>-j make</em> flag is very usefull.</p>
</div>
<div class="section" id="providing-additionnal-c-compiler-options">
<h3>Providing additionnal C compiler options<a class="headerlink" href="#providing-additionnal-c-compiler-options" title="Permalink to this headline">¶</a></h3>
<p><em>Make</em> also let you pass options to the compiler it&#8217;ll use, by providing the CFLAGS variable.
With PHP, you cant pass them directly to <em>make</em> as libtool is used and just ignores them. Better pass them to your configure script.</p>
<p>Should you want to experiment performance flags of GCC, you could use, for example :</p>
<div class="highlight-none"><div class="highlight"><pre>src/&gt; CFLAGS=&quot;-O4 -march=native&quot; ./configure &amp;&amp; make
</pre></div>
</div>
<p>Those two GCC flags will tell it to compile the files with the maximum optimization level, and to produce machine code for the actual CPU (native architecture), which, depending on your hardware, can give a performance boost to the resulting PHP.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Master your compiler and your architecture if you come to play with GCC optimization level and flags. If you dont, you can end up with a PHP randomly crashing. We dont really support high level of optimization in PHP source code, we support the default -O2 level. But if know what you talk about, go for it.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Perhaps reading <a class="reference external" href="http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">http://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html</a> may help here. You&#8217;ll find lots of information about GCC flags.</p>
</div>
</div>
</div>
<div class="section" id="compilation-usual-problems">
<h2>Compilation usual problems<a class="headerlink" href="#compilation-usual-problems" title="Permalink to this headline">¶</a></h2>
<p>As you may know, <em>make</em> makes a cache of all the objects it builds, so that its next invocations will be much faster. If you change just one C source file and run <em>make</em> again, it should guess this and only compile the dedicated object, then tries to link again and end out with the final build.
But, sometimes, this just does not work well. If you experience strange errors in <em>make</em> output, and have invoked <em>make</em> several times before, think about running <em>make clean</em>, which will delete all the compiled objects so that the next <em>make</em> call starts the compilation back from the beginning on a clean basis.</p>
<p>Also, if you play with <em>configure</em> options and change them before invoking <em>make</em>, better as well to run* make clean* before <em>make</em>.</p>
<p>There also exists a <em>make</em> target called <em>&#8220;distclean&#8221;</em>, which is a normal clean, but it also rolls back all the stuff brought by the <em>./configure</em> command invocation (it deletes configure caches, as well as the <em>Makefile</em> and other temporary files).
In short, remember <em>make distclean</em> as beeing a total cleanup of anything created or modified by previous <em>configure</em> or <em>make</em> calls.</p>
<p>If you use PHP sources from git, or if you modify m4 files (we talk about such files in the extensions dedicated chapter), then you always have to rebuild the configure script.
If you dont, you&#8217;ll meet errors at compilation, for sure, because you invoke <em>configure</em> so that it will prepare files based on an old API you modified. <em>configure</em> has no way to guess new C files to prepare for compilation or new checks to perform : you must rebuild the configure script.
This is done by deleting the configure script and running the buildconf script, usually with the &#8220;force&#8221; switch :</p>
<div class="highlight-none"><div class="highlight"><pre>&gt; rm configure
&gt; ./buildconf --force
Forcing buildconf
Removing configure caches
buildconf: checking installation...
buildconf: autoconf version 2.69 (ok)
rebuilding aclocal.m4
rebuilding configure
rebuilding main/php_config.h.in
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Think about deleting the configure script before invoking the buildconf script.</p>
</div>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="packages_vs_source.html">Packages versus sources</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="extensions_pecl.html">Building PHP Extensions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer feedback">
        Send feedback to <a href="mailto:feedback@phpinternalsbook.com">feedback@phpinternalsbook.com</a>
    </div>
    
    <div class="footer">
        &copy; Copyright 2013, Julien Pauli - Anthony Ferrara - Nikita Popov.
    </div>
    <div class="footer feedback">
        All Rights Reserved
    </div>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-41617167-1', 'phpinternalsbook.com');
      ga('send', 'pageview');
    </script>

  </body>
</html>